<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>X-ray Analysis | Fracture & Pneumonia</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
      .panel { background:#f6f9fc; padding:26px 32px; border-radius:14px; max-width:560px; margin:48px auto;
               box-shadow:0 2px 10px rgba(0,0,0,0.08); }
      fieldset { border:1px solid #d0dce5; padding:12px 16px; border-radius:10px; }
      legend { padding:0 6px; font-size:0.95em; color:#2c5368; }
      label { display:block; margin:4px 0; cursor:pointer; }
      .flash { margin-top:12px; color:#c0392b; }
      .loading { display:none; margin-top:20px; text-align:center; color:#2c5368; }
      .loading.show { display:block; }
      .error { color:#c0392b; margin-top:12px; }
      .hidden { display:none; }
    </style>
</head>
<body>
  <div class="panel">
      <h1>X-ray AI Analysis</h1>
      <p>Select a task, upload an image (PNG/JPG). AI returns structured findings & explanation in real-time.</p>
      
      <form id="analysisForm">
          <fieldset>
              <legend>Task</legend>
              <label><input type="radio" name="task_mode" value="fracture" checked> Fracture Detection</label>
              <label><input type="radio" name="task_mode" value="pneumonia"> Classify & Detect Pneumonia</label>
          </fieldset>
          <div style="margin-top:16px;">
              <input type="file" name="file" id="fileInput" accept=".png,.jpg,.jpeg" required>
          </div>
          <div style="margin-top:20px;">
              <button type="submit" id="analyzeBtn">Analyze Image</button>
          </div>
      </form>
      
      <div class="loading" id="loadingDiv">
          <p>ðŸ”¬ Analyzing image with AI models...</p>
      </div>
      
      <div class="error" id="errorDiv" style="display:none;"></div>
  </div>

  <!-- Results container -->
  <div id="resultsContainer" class="hidden"></div>

  <script>
    document.getElementById('analysisForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData();
        const fileInput = document.getElementById('fileInput');
        const taskMode = document.querySelector('input[name="task_mode"]:checked').value;
        
        if (!fileInput.files[0]) {
            showError('Please select an image file.');
            return;
        }
        
        formData.append('file', fileInput.files[0]);
        formData.append('task_mode', taskMode);
        
        showLoading(true);
        hideError();
        hideResults();
        
        try {
            const response = await fetch('/analyze', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.error || 'Analysis failed');
            }
            
            showResults(result);
        } catch (error) {
            showError(error.message);
        } finally {
            showLoading(false);
        }
    });
    
    function showLoading(show) {
        document.getElementById('loadingDiv').classList.toggle('show', show);
        document.getElementById('analyzeBtn').disabled = show;
    }
    
    function showError(message) {
        const errorDiv = document.getElementById('errorDiv');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }
    
    function hideError() {
        document.getElementById('errorDiv').style.display = 'none';
    }
    
    function hideResults() {
        document.getElementById('resultsContainer').classList.add('hidden');
    }
    
    function showResults(data) {
        const container = document.getElementById('resultsContainer');
        container.innerHTML = generateResultsHTML(data);
        container.classList.remove('hidden');
        container.scrollIntoView({ behavior: 'smooth' });
    }
    
    function generateResultsHTML(data) {
        const severityClass = data.severity || 'none';
        
        let html = `
        <div style="max-width:800px; margin:40px auto; padding:0 20px;">
            <h1>AI Analysis Result
                <span class="badge ${severityClass}">${(data.severity || 'none').charAt(0).toUpperCase() + (data.severity || 'none').slice(1)}</span>
            </h1>
        `;
        
        // Images section
        if (data.original_image) {
            html += `
            <div class="images">
                <div>
                    <h3>Original X-ray</h3>
                    <img src="data:image/jpeg;base64,${data.original_image}" alt="Original X-ray" style="max-width:340px; border:1px solid #ddd; border-radius:8px;">
                </div>
            `;
            
            if (data.annotated_image && data.annotated_image !== data.original_image) {
                html += `
                <div>
                    <h3>Annotated</h3>
                    <img src="data:image/jpeg;base64,${data.annotated_image}" alt="Annotated" style="max-width:340px; border:1px solid #ddd; border-radius:8px;">
                </div>
                `;
            }
            
            html += `</div>`;
        }
        
        // Visual inspection
        if (data.visual_inspection) {
            const vi = data.visual_inspection;
            html += `
            <div class="card">
                <h2>Visual Inspection (Gemini)</h2>
                <p><strong>Description:</strong> ${vi.raw_description}</p>
                <p><strong>Detected type:</strong> ${vi.detected_type} (confidence hint ${vi.confidence_hint.toFixed(2)})</p>
                <p style="font-size:0.85em;color:#555;"><strong>Rationale:</strong> ${vi.rationale}</p>
            </div>
            `;
        }
        
        // Task-specific results
        html += `<div class="card">`;
        
        if (data.task === 'fracture_detection') {
            html += `<h2>Fracture Findings</h2>`;
            if (data.num_detections === 0) {
                html += `<p style="color:green;"><strong>No fractures detected by model.</strong></p>`;
            } else {
                html += `<ul>`;
                data.detections.forEach(d => {
                    html += `<li>${d.label} - Conf ${d.confidence.toFixed(2)} - Box [${d.box.join(', ')}]</li>`;
                });
                html += `</ul>`;
            }
        } else if (data.task === 'pneumonia_analysis') {
            html += `
            <h2>Pneumonia Classification</h2>
            <p>Result: <strong>${data.classification.label}</strong> â€” Confidence: ${data.classification.confidence.toFixed(3)}</p>
            `;
            
            if (data.classification.probabilities && data.classification.probabilities.length > 0) {
                html += `<h4>Class Probabilities</h4><ul>`;
                data.classification.probabilities.forEach((p, i) => {
                    html += `<li>${data.classification.class_names[i]}: ${p.toFixed(3)}</li>`;
                });
                html += `</ul>`;
            }
            
            if (data.classification.label.toLowerCase() === 'pneumonia') {
                html += `<h3>Localization</h3>`;
                if (data.regions_found === 0) {
                    html += `<p>No regions localized.</p>`;
                } else {
                    html += `<ul>`;
                    data.regional_detections.forEach(r => {
                        html += `<li>${r.label} - Conf ${r.confidence.toFixed(2)} - Box [${r.box.join(', ')}]</li>`;
                    });
                    html += `</ul>`;
                }
            }
        }
        
        html += `</div>`;
        
        // AI explanation
        if (data.ai_explanation) {
            const exp = data.ai_explanation;
            html += `
            <div class="card">
                <h2>AI Structured Explanation</h2>
                <div class="sections">
                    <div class="section-box">
                        <h4>Summary</h4>
                        <p>${exp.summary}</p>
                    </div>
                    <div class="section-box">
                        <h4>Risk Level</h4>
                        <p>${exp.risk_level.charAt(0).toUpperCase() + exp.risk_level.slice(1)}</p>
                    </div>
                    <div class="section-box">
                        <h4>Reasoning</h4>
                        <p>${exp.reasoning}</p>
                    </div>
                    <div class="section-box">
                        <h4>Detection Analysis</h4>
                        <p>${exp.detection_analysis}</p>
                    </div>
                    <div class="section-box">
                        <h4>Recommendations</h4>
                        <p>
            `;
            
            if (exp.recommendations.includes(';')) {
                html += `<ul>`;
                exp.recommendations.split(';').forEach(seg => {
                    if (seg.trim()) {
                        html += `<li>${seg.trim()}</li>`;
                    }
                });
                html += `</ul>`;
            } else {
                html += exp.recommendations;
            }
            
            html += `
                        </p>
                    </div>
                    <div class="section-box">
                        <h4>Follow Up</h4>
                        <p>${exp.follow_up}</p>
                    </div>
                    <div class="section-box">
                        <h4>Disclaimer</h4>
                        <p style="font-size:0.85em;color:#555;">${exp.disclaimer}</p>
                    </div>
                </div>
            </div>
            `;
        }
        
        html += `
            <p style="margin-top:26px;">
                <button onclick="location.reload()" style="background:#1273de; color:#fff; border:none; padding:10px 18px; border-radius:6px; cursor:pointer;">Analyze Another Image</button>
            </p>
        </div>
        `;
        
        return html;
    }
  </script>

  <style>
    .images { display:flex; gap:40px; flex-wrap:wrap; margin-top:10px; }
    .card { background:#f8fafd; border-radius:12px; padding:22px 26px; box-shadow:0 2px 8px rgba(0,0,0,0.07); margin-top:24px; }
    .sections { display:grid; gap:18px; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); margin-top:14px; }
    .section-box { background:#fff; border:1px solid #dfe7ef; border-radius:10px; padding:14px 16px; }
    .section-box h4 { margin:0 0 6px; font-size:0.95rem; letter-spacing:.5px; text-transform:uppercase; color:#2d5166; }
    .badge { display:inline-block; background:#1273de; color:#fff; font-size:0.72em; padding:4px 9px; border-radius:14px; margin-left:10px; }
    .high { background:#c0392b; }
    .moderate { background:#e67e22; }
    .low { background:#f39c12; }
    .none { background:#2ecc71; }
  </style>
</body>
</html>